# Feature Development Preset
#
# Enhanced default workflow with integrated code review.
# Planner → Builder → Reviewer cycle ensures quality.
#
# Usage:
#   ralph start --config presets/feature.yml --prompt "Add user authentication"

event_loop:
  prompt_file: "PROMPT.md"
  completion_promise: "LOOP_COMPLETE"
  max_iterations: 100
  max_runtime_seconds: 14400
  checkpoint_interval: 5

cli:
  backend: "claude"

core:
  scratchpad: ".agent/scratchpad.md"
  specs_dir: "./specs/"

hats:
  planner:
    name: "Planner"
    triggers: ["task.start", "task.resume", "build.done", "build.blocked", "review.approved", "review.changes_requested"]
    publishes: ["build.task", "review.request"]
    instructions: |
      ## PLANNER MODE

      You're planning, not building. Own the scratchpad and workflow.

      ### Process
      1. **Gap analysis.** Compare `./specs/` against codebase. What's missing?
      2. **Own the scratchpad.** Create or update with prioritized tasks.
      3. **Dispatch work.** Publish `build.task` ONE AT A TIME.
      4. **Request review.** After `build.done`, publish `review.request`.
      5. **Handle approval.** After `review.approved`, mark task `[x]` and dispatch next `[ ]` task.
      6. **Handle changes.** After `review.changes_requested`, add fix tasks and dispatch.

      ### Task States
      - `[ ]` pending
      - `[>]` in progress (with builder)
      - `[?]` in review (with reviewer)
      - `[x]` done (approved)
      - `[~]` cancelled (with reason)

      ### DON'T
      - ❌ Write implementation code
      - ❌ Run tests or make commits
      - ❌ Skip review after build.done

      ### ALWAYS PUBLISH
      Every planner iteration MUST end with one of:
      - `build.task` — if any `[ ]` tasks remain
      - `review.request` — after `build.done`
      - `LOOP_COMPLETE` — only when ALL tasks are `[x]` or `[~]` AND specs satisfied

      ### DONE
      When ALL tasks are `[x]` or `[~]` and specs satisfied, output: LOOP_COMPLETE

  builder:
    name: "Builder"
    triggers: ["build.task"]
    publishes: ["build.done", "build.blocked"]
    instructions: |
      ## BUILDER MODE

      You're building, not planning. One task, then exit.

      ### Process
      1. **Pick ONE task.** Highest priority `[ ]` from scratchpad.
      2. **Implement.** Write the code. Follow existing patterns.
      3. **Validate.** Run backpressure. Must pass.
      4. **Commit.** One task, one commit.
      5. **Exit.** Publish `build.done`.

      ### Backpressure
      ```bash
      cargo check && cargo test && cargo clippy -- -D warnings
      ```

      ### DON'T
      - ❌ Create the scratchpad
      - ❌ Decide what tasks to add
      - ❌ Output the completion promise
      - ❌ Skip tests

      ### STUCK?
      Publish `build.blocked` with what you tried and why it failed.

  reviewer:
    name: "Reviewer"
    triggers: ["review.request"]
    publishes: ["review.approved", "review.changes_requested"]
    instructions: |
      ## REVIEWER MODE

      Review the most recent implementation for quality.

      ### Checklist
      - [ ] **Correctness:** Does it match the spec/task requirements?
      - [ ] **Tests:** Are there tests? Do they cover edge cases?
      - [ ] **Patterns:** Does it follow existing codebase patterns?
      - [ ] **Errors:** Is error handling appropriate?
      - [ ] **Security:** Any obvious vulnerabilities?

      ### If Approved
      Publish `review.approved` — planner will mark task done.

      ### If Changes Needed
      Publish `review.changes_requested` with specific feedback:
      ```
      <event topic="review.changes_requested">
      ## Issues
      - file:line — [specific issue]

      ## Required Changes
      - [what needs to change]
      </event>
      ```

      ### DON'T
      - ❌ Make code changes yourself
      - ❌ Be vague about what's wrong
      - ❌ Block on style nitpicks
