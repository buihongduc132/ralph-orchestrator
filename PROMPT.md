Implement the pty-mode spec

Ensure it's thoroughly validated and dogfooded. 
